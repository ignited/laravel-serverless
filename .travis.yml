language: php

node_js:
  - 12

services:
  - docker

php:
  - 7.2
  - 7.3
env:
  matrix:
  - LARAVEL=5.5.*
  - LARAVEL=5.6.*
  - LARAVEL=5.7.*
  - LARAVEL=5.8.*
  - LARAVEL=6.0.*

before_install:
  # Install Serverless
  - npm install -g serverless@1.43.0

  # Install package's composer
  - composer install

  # Install Laravel
  - export TMP_LARAVEL_PATH=/tmp/laravel
  - composer create-project laravel/laravel $TMP_LARAVEL_PATH ${LARAVEL} --prefer-dist

  - cd $TMP_LARAVEL_PATH

  # Copy across the layers
  - cp -R $TRAVIS_BUILD_DIR/layers .
  - cp layers/laravelBootstrap.php layers/web/
  - cp layers/laravelBootstrap.php layers/cli/

  # Install laravel-serverless
  - rm -rf composer.lock
  - composer config repositories.ignited/laravel-serverless vcs $TRAVIS_BUILD_DIR
  - composer require ignited/laravel-serverless "dev-master" --prefer-source

before_script:
  # Copy Serverless Config
  - cp $TRAVIS_BUILD_DIR/tests/serverless.yml .
  - export PHP_VERSION=$(echo "$TRAVIS_PHP_VERSION" | sed -e 's/\.//g')

script:
  # Test the package's PHPunit
  - ( cd $TRAVIS_BUILD_DIR ; vendor/bin/phpunit )

  # Now Test the Laravel Install

  # Test HTTP Works
  - serverless invoke local --docker --function web -e SESSION_DRIVER=array --path $TRAVIS_BUILD_DIR/tests/events/http.json -l

  # Test CLI Works
  - serverless invoke local --docker --function cli --path $TRAVIS_BUILD_DIR/tests/events/cli.json -l